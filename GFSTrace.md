# GFS трасса для отслеживания операций GETMAIN/FREEMAIN/STORAGE OBTAIN #
## Кратко ##
Данный инструмент позволяет отследить все операции выделения или освобождения памяти в пределах указанных адресных пространств. Эти адресные пространства можно идентифицировать с помощью ASID или JOB name. Результатом работы трассы является датасет с неформатированным дампом. Посмотреть дамп в удобоваримом, форматированном виде можно с помощью IPCS
## Подробно ##
Итак, есть задача протрассировать операции выделения и освобождения памяти в JOB JOBNAME. Для этого надо:
  * активировать трассу
  * запустить GTF
  * запустить JOB
  * остановить GTF
  * деактивировать трассу (опционально)
  * посмотреть собранную информацию с помощью IPCS
### Активация трассы ###
Для активации трассы, в ADCD.Z110.PARMLIB надо изменить DIAG00 и DIAG 01. DIAG00 будет активировать трассу и содержать:
```

VSM TRACE GETFREE (ON)
LENGTH (0-8192)
DATA (ALL)              ```
В первой строке активируем трассу. Во второй строке - ограничение на события: отслеживаем выделение и удаление блоков памяти длиной от 0 до 8192 байт. В третьей строке указываем, что хотим иметь всю доступную информацию о событии.
DIAG01 будет деактивировать трассу и выглядеть таким образом:
```

VSM TRACE GETFREE (OFF)
```
Для активации трассы пишем в консоли оператора (там, где лог бежит)
```
SET DIAG=00```
### Запуск GTF ###
В библиотеке SYS1.PROCLIB создаем мембера GETMEM, который будет содержать:
```

//GTFMEM  JOB
//* Starts GTF
//IEFPROC  EXEC PGM=AHLGTF,REGION=32M,
//  PARM='MODE=EXT,DEBUG=NO,TIME=YES,BLOK=40K,SD=0K,SA=40K'
//IEFRDER DD   DSNAME=EMCPROJ.MEM.TRACE,UNIT=SYSDA,SPACE=(TRK,200),
//          DISP=(NEW,KEEP),VOL=SER=ZAIMS1
//SYSLIB  DD   DSN=EMCPROJ.PARMLIB(GTFMEM),DISP=SHR
```
На самом деле надо создать каталогизированную процедуру, но с ней могут возникнуть проблемы в плане остановки GTF: она банально будет не внесена в список активных JOB.
Данный JCL создаст датасет EMCPROJ.MEM.TRACE и запустит GTF так, чтобы он писал в него неформатированные трассировочные записи.
Если датасет уже существует, то JES2 заругается и не запустит GTF.
В датасете EMCPROJ.PARMLIB(GTFMEM) содержатся параметры для GTF. Укажем такие:
```

TRACE=USRP,JOBNAMEP
USR=(F65)
JOBNAME=(JOBNAME)
END
```
Первая строка - список параметров. Вторая строка - указание на то что хочется поймать события выделения или освобождения памяти. Третья строка указывает, что мы хотим ловить такие события только для JOB с именем JOBNAME.
Для запуска GTF надо в данном случае ввести в консоли оператора:
```
START GETMEM```
### Запуск исследуемой программы ###
Трассировка будет проводиться для ВСЕГО JOB. То есть, если в JOB будет входить компиляция, линковка программы и еще черт знает что, то будет протрассировано абсолютно все: от компиляции до запуска IEFBR14, если он есть. Таким образом, надо создать JOB, который будет запускать исследуемую программу и ничего более. Создать и запустить.
### Остановка GTF ###
Для остановки GTF надо ввести в консоли оператора такую команду:
```
STOP GETMEM```
В случае успеха, GTF скажет, что понял команду и укажет датасет, куда сложил неформатированный дамп.
### Деактивация трассы ###
Для деактивации трассы пишем в консоли оператора (там, где лог бежит)
```
SET DIAG=01```
### Просмотр неформатированных данных с помощью IPCS ###
Для этого идем в m.6, вводим ipcs, идем в 6, там вводим команду
```
GTFTRACE DA('EMCPROJ.MEM.TRACE') USR(F65)```
Теперь остается разобраться в собранной информации.